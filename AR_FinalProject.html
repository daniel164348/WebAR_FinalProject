<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>WebAR_FinalProject</title>
        <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
        <style>
        html, body {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        overflow: hidden;
        }
        a-scene {
        width: 100%; height: 100%;
        position: fixed; top: 0; left: 0;
        }
        /* 隱藏所有 MindAR 預設 UI */
        .mindar-ui-loading,
        .mindar-ui-error,
        .mindar-ui-scanning {
        display: none;
        }
        
        /*UI Style*/

        .button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: row; 
            gap: 15px;
        }
        .ar-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
            /* 防止長按選單 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .ar-button:hover {
            transform: scale(1.1);
        }
        .info-button {
            background-color: rgba(33, 150, 243, 0.8);
        }
        .source-button {
            background-color: rgba(76, 175, 80, 0.8);
        }
        .button-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            pointer-events: none; /* 防止圖片接收事件 */
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 5;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .overlay-content {
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            background-color: rgba(0,0,0,0.85);
            border-radius: 10px;
            padding: 20px;
            color: white;
            position: relative;
            overflow-y: auto;
        }
        .overlay-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .overlay-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ff5252;
            border: 2px solid #d32f2f;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        #custom-Text{
            display: none;
            position: fixed;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0,0,0.6);
            color: white;
            padding: 0.5em 1em;
            font-size: 1.5em;
            border-radius: 0.3em;
            z-index: 5;
            pointer-events: none;
        }

        </style>
    </head>
    <body>
        <!--25.5.6 0.9Ver Single Planets / Slide Rotation-->

        <!--UI Button & Text-->
        <div id="custom-Text">
            
        </div>
        <div class="button-container">
        <div class="ar-button info-button" id="info-button" ontouchstart="">
            <img class="button-img" src="./UIPhoto/help.png" id="info-button-img">
        </div>
        <div class="ar-button source-button" id="source-button" ontouchstart="">
            <img class="button-img" src="./UIPhoto/info.png" id="source-button-img">
        </div>
    </div>

        <div class="overlay" id="info-overlay">
        <div class="overlay-content">
            <div class="close-button" id="close-info">X</div>
            <div class="overlay-title" id="titleDiv">星球說明視窗</div>
            <div class="overlay-text" id="description_1">
                透過掃描圖片後可以在這裡看到該星球相關的文字說明!
            </div>
            <div class="overlay-text" id="description_2">
                
            </div>
            <div class="overlay-text" id="description_3">
                
            </div>
            <div class="overlay-text" id="description_4">
                
            </div>
            <div class="overlay-text" id="description_5">
                
            </div>
            <div class="overlay-text" id="description_6">
                
            </div>
        </div>
    </div>

    <!-- 出處說明覆蓋層 -->
    <div class="overlay" id="source-overlay">
        <div class="overlay-content">
            <div class="close-button" id="close-source">X</div>
            <div class="overlay-title">使用說明</div>
            <div class="overlay-text" id="helpwithsource_1">
                歡迎使用 此網頁版AR! 
            </div>
            <div class="overlay-text" id="helpwithsource_2">
                透過掃描說明內附帶的圖片就可以看見太陽系的各種星球!
            </div>
            <div class="overlay-text" id="helpwithsource_3">
                除了名稱會顯示之外，模型可以透過拖曳來轉動
            </div>
            <div class="overlay-text" id="helpwithsource_4">
                還可以按下問號按鈕查看當前該星球的介紹!
            </div>
            <div class="overlay-title">版權聲明</div>
            <div class="overlay-text" id="helpwithsource_5">
                Jupiter Model by RecourseDesign<br>
                以上素材來自 Fab 模型網站，依據 CC BY 4.0使用，模型僅供展示(未修改)
            </div>
            </div>
        </div>

        <!--AR Scene -->

        <a-scene
        mindar-image="
        imageTargetSrc: targets.mind;
        autoStart: true;
        showStats: false;
        uiLoading: no;
        uiScanning: no;
        uiError: no;
        "
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        >
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!--Model Assets(PreLoad)-->
        <a-assets>
            <a-assets-item id="jupiterAssetsItem" src="./jupiter_model/scene.gltf"></a-assets-item>
            
        </a-assets>

        <!--AR Scan Entity-->

        <a-entity class="target" data-index="jupiter" mindar-image-target="targetIndex: 0"></a-entity>

        <!--AR Model (Showing in Scene)-->

        <a-entity gltf-model="#jupiterAssetsItem" id="jupiterModel" position="0 0 -30" scale="0.05 0.05 0.05" visible="false" touch-rotation></a-entity>

        </a-scene>
        
        <script>
        window.addEventListener("load", () => {
            
        //Model Const
        const jupiterModel = document.querySelector("#jupiterModel");

        // UI Const
        const PlanetTitleText = document.getElementById('custom-Text');

        //AR Scanner & ModelSelector
        document.querySelectorAll('.target').forEach(target =>{
            target.addEventListener('targetFound', () =>{
                const dataName = target.dataset.index;

                if(dataName === "jupiter"){
                    jupiterModel.setAttribute("visible",true);
                    jupiterModel.setAttribute("touch-rotation", "enabled", true);

                    PlanetTitleText.innerHTML = "木星";
                }

                PlanetTitleText.style.display = "block";
            });

            target.addEventListener('targetLost', () =>{
                //Model hide(*)
                jupiterModel.setAttribute("visible",false);
                jupiterModel.setAttribute("touch-rotation", "enabled", false);

                PlanetTitleText.style.display = "none";
            });
        });

        //A-Frame Component 
        AFRAME.registerComponent('touch-rotation', {
        schema: {
            speedFactor: { default: 0.3 },
            enableXRotation: { default: true },
            enableYRotation: { default: true },
            minRotationX: { default: -90 },
            maxRotationX: { default: 90 },
            enabled: { default: false }
        },
        
        init: function() {
            this.xRotation = 0;
            this.yRotation = 0;
            this.touchStartX = 0;
            this.touchStartY = 0;
            this.isRotating = false;
            
            const rotation = this.el.object3D.rotation;
            this.xRotation = THREE.MathUtils.radToDeg(rotation.x);
            this.yRotation = THREE.MathUtils.radToDeg(rotation.y);
            
            this.onTouchStart = this.onTouchStart.bind(this);
            this.onTouchMove = this.onTouchMove.bind(this);
            this.onTouchEnd = this.onTouchEnd.bind(this);
            
            this.el.sceneEl.addEventListener('targetFound', this.enableTouchRotation.bind(this));
            this.el.sceneEl.addEventListener('targetLost', this.disableTouchRotation.bind(this));
            
            if (this.data.enabled) {
                this.addTouchEventListeners();
            }
        },
        
        enableTouchRotation: function() {
            if (!this.data.enabled) {
                this.data.enabled = true;
                this.addTouchEventListeners();
            }
        },
        
        disableTouchRotation: function() {
            if (this.data.enabled) {
                this.data.enabled = false;
                this.removeTouchEventListeners();
            }
        },
        
        addTouchEventListeners: function() {
            document.addEventListener('touchstart', this.onTouchStart);
            document.addEventListener('touchmove', this.onTouchMove);
            document.addEventListener('touchend', this.onTouchEnd);
        },
        
        removeTouchEventListeners: function() {
            document.removeEventListener('touchstart', this.onTouchStart);
            document.removeEventListener('touchmove', this.onTouchMove);
            document.removeEventListener('touchend', this.onTouchEnd);
            this.isRotating = false;
        },
        
        onTouchStart: function(event) {
            if (!this.data.enabled) return;
            
            if (event.touches.length === 1) {
                this.isRotating = true;
                this.touchStartX = event.touches[0].pageX;
                this.touchStartY = event.touches[0].pageY;
                event.preventDefault();
            }
        },
        
        onTouchMove: function(event) {
            if (!this.data.enabled || !this.isRotating || event.touches.length !== 1) return;
            
            const touchX = event.touches[0].pageX;
            const touchY = event.touches[0].pageY;
            
            const deltaX = touchX - this.touchStartX;
            const deltaY = touchY - this.touchStartY;
            
            if (this.data.enableYRotation) {
                this.yRotation += deltaX * this.data.speedFactor;
            }
            
            if (this.data.enableXRotation) {
                const newXRotation = this.xRotation - deltaY * this.data.speedFactor;
                this.xRotation = Math.max(this.data.minRotationX, Math.min(this.data.maxRotationX, newXRotation));
            }
            
            this.el.object3D.rotation.set(
                THREE.MathUtils.degToRad(this.xRotation),
                THREE.MathUtils.degToRad(this.yRotation),
                0
            );
            
            this.touchStartX = touchX;
            this.touchStartY = touchY;
            
            event.preventDefault();
        },
        
        onTouchEnd: function() {
            this.isRotating = false;
        },
        
        update: function(oldData) {
            if (oldData.enabled !== this.data.enabled) {
                if (this.data.enabled) {
                    this.addTouchEventListeners();
                } else {
                    this.removeTouchEventListeners();
                }
            }
        },
        
        remove: function() {
            this.removeTouchEventListeners();
            this.el.sceneEl.removeEventListener('targetFound', this.enableTouchRotation);
            this.el.sceneEl.removeEventListener('targetLost', this.disableTouchRotation);
        }
        });

        //Button 
        const infoButton = document.getElementById('info-button');
        const sourceButton = document.getElementById('source-button');
        const infoOverlay = document.getElementById('info-overlay');
        const sourceOverlay = document.getElementById('source-overlay');
        const closeInfo = document.getElementById('close-info');
        const closeSource = document.getElementById('close-source');

        infoButton.addEventListener('click', function() {
            sourceOverlay.style.display = 'none';
            sourceOverlay.style.opacity = '0';
            
            infoOverlay.style.display = 'flex';
            setTimeout(() => {
                infoOverlay.style.opacity = '1';
            }, 10);
        });

        sourceButton.addEventListener('click', function() {
            infoOverlay.style.display = 'none';
            infoOverlay.style.opacity = '0';
            
            sourceOverlay.style.display = 'flex';
            setTimeout(() => {
                sourceOverlay.style.opacity = '1';
            }, 10);
        });

        closeInfo.addEventListener('click', function() {
            infoOverlay.style.opacity = '0';
            setTimeout(() => {
                infoOverlay.style.display = 'none';
            }, 300);
        });

        closeSource.addEventListener('click', function() {
            sourceOverlay.style.opacity = '0';
            setTimeout(() => {
                sourceOverlay.style.display = 'none';
            }, 300);
        });

        infoOverlay.addEventListener('click', function(e) {
            if (e.target === infoOverlay) {
                infoOverlay.style.opacity = '0';
                setTimeout(() => {
                    infoOverlay.style.display = 'none';
                }, 300);
            }
        });

        sourceOverlay.addEventListener('click', function(e) {
            if (e.target === sourceOverlay) {
                sourceOverlay.style.opacity = '0';
                setTimeout(() => {
                    sourceOverlay.style.display = 'none';
                }, 300);
            }
        });

    });

        </script>
    </body>
</html>

