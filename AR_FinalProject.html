<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>WebAR_FinalProject</title>
        <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
        <style>
        html, body {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        overflow: hidden;
        }
        a-scene {
        width: 100%; height: 100%;
        position: fixed; top: 0; left: 0;
        }
        /* 隱藏所有 MindAR 預設 UI */
        .mindar-ui-loading,
        .mindar-ui-error,
        .mindar-ui-scanning {
        display: none;
        }
        
        /*UI Style*/

        #custom-btn {
        display: none;
        position: fixed;
        bottom: 10px; 
        left: 5%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 0.5em 1em;
        font-size: 1.5em;
        border-radius: 0.3em;
        z-index: 9999;
        pointer-events: auto;
        user-select: none;
        box-shadow: rgba(0, 0, 0, 0.4);
        transition: all 0.15s ease;
        }

        /*
        #custom-rightbtn {
        display: none; 
        position: fixed;
        bottom: 20px; 
        right: 25%;
        transform: translateX(50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 0.5em 1em;
        font-size: 1.5em;
        border-radius: 0.3em;
        z-index: 9999;
        pointer-events: auto;
        user-select: none;
        box-shadow: rgba(0, 0, 0, 0.4);
        transition: all 0.15s ease;
        }*/

        #custom-btn:active {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            transform: scale(0.95) translateX(-50%);
        }

        /*
        #custom-rightbtn:active {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            transform: scale(0.95) translateX(50%);
        }
        */

        img.Btn {
            pointer-events: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .slide-zone{
            position: fixed;
            bottom: 50px;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            z-index: 9998;
            pointer-events: auto;
        }

        </style>
    </head>
    <body>
        <!--25.5.6 0.2Ver Single Planets / Slide Rotation-->
        <!-- UI Scene -->
        <button type="button" id="custom-btn" disabled><img src="./UIPhoto/info.png" class="Btn"></button>
        <!--<button type="button" id="custom-leftbtn" disabled><img src="./UIPhoto/arrow_left.png" class="Btn"></button>
        <button type="button" id="custom-rightbtn" disabled><img src="./UIPhoto/arrow_right.png" class="Btn"></button>-->

        <!--Slide Zone-->
        <div class="slide-zone"></div>
        <!--AR Scene -->

        <a-scene
        mindar-image="
        imageTargetSrc: targets.mind;
        autoStart: true;
        showStats: false;
        uiLoading: no;
        uiScanning: no;
        uiError: no;
        "
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        >
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!--Model Assets(PreLoad)-->
        <a-assets>
            <a-assets-item id="jupiterAssetsItem" src="./jupiter_model/scene.gltf"></a-assets-item>
            
        </a-assets>

        <!--AR Scan Entity-->

        <a-entity class="target" data-index="jupiter" mindar-image-target="targetIndex: 0"></a-entity>

        <!--AR Model (Showing in Scene)-->

        <a-entity gltf-model="#jupiterAssetsItem" id="jupiterModel" position="0 0 -30" scale="0.05 0.05 0.05" visible="false"></a-entity>

        </a-scene>
        
        <script>
        window.addEventListener("load", () => {
        function resizeSlideZone(){
            const slideZone = document.getElementById("slide-zone");
            const screenHeight = window.innerHeight;

            slideZone.style.height = `${screenHeight * 0.2} px`;
        }
        //SlideZoneSet&Resize
        resizeSlideZone();
        
        //Model Const
        const jupiterModel = document.querySelector("#jupiterModel");

        // UI Const
        const TextBtn = document.getElementById('custom-btn');

        //AR Scanner & ModelSelector
        document.querySelectorAll('.target').forEach(target =>{
            target.addEventListener('targetFound', () =>{
                const dataName = target.dataset.index;

                if(dataName === "jupiter"){
                    jupiterModel.setAttribute("visible",true);
                    jupiterModel.setAttribute("slide-rotate", 'enabled', true);
                }

                TextBtn.disabled = false;
                TextBtn.style.display = "block";
            });

            target.addEventListener('targetLost', () =>{
                //Model hide(*)
                jupiterModel.setAttribute("visible",false);
                jupiterModel.setAttribute("slide-rotate", 'enabled', false);

                TextBtn.disabled = false;
                TextBtn.style.display = "block";
            });
        });

        //A-Frame Component 
        AFRAME.registerComponent('slide-rotate', {
            schema: {
                enabled:{ type: 'boolean', default: true },
                radius: { type: 'number', default: 100 }
            },

            init()
            {
                this.isSliding = false;
                this.lastX = 0;
                this.lastY = 0;

                this.onTouchStart = (e) =>{
                    if(!this.data.enabled) return;

                    const slideZone = document.getElementById("slide-zone");
                    const slideZoneRect = slideZone.getBoundingClientRect();

                    const touchX = e.touches[0].clientX;
                    const touchY = e.touches[0].clientY;

                    if(touchX >= slideZone.left && touchX <= slideZone.right && touchY >= slideZone.top && touchY <= slideZone.bottom)
                    {
                        this.isSliding = true;
                        this.lastX = touchX;
                        this.lastY = touchY;
                    }
                };

                this.onTouchMove = (e) => {
                    if(!this.isSliding || !this.data.enabled) return;

                    const deltaX = e.touches[0].clientX - this.lastX;
                    const deltaY = e.touches[0].clientY - this.lastY;

                    const rot = this.el.getAttribute('rotation');
                    rot.y += deltaX * 0.2;
                    rot.x += deltaY * 0.2;
                    this.el.setAttribute("rotation", rot);

                    this.lastX = e.touches[0].clientX;
                    this.lastY = e.touches[0].clientY;
                };

                this.onTouchEnd = () => {
                    this.isSliding = false;
                };

                window.addEventListener('touchstart',this.onTouchStart);
                window.addEventListener('touchmove', this.onTouchMove);
                window.addEventListener('touchend',this.onTouchEnd);
            },

            remove()
            {
                window.removeEventListener('touchstart', this.onTouchStart);
                window.removeEventListener('touchmove', this.onTouchMove);
                window.removeEventListener('touchend',this.onTouchEnd);
            }
        });

        document.querySelectorAll('img.Btn').forEach(img =>{
            img.addEventListener('touchstart',e => e.preventDefault());
        });

        });
        
        </script>
    </body>
</html>

