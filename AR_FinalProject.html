<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>WebAR_FinalProject</title>
        <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
        <style>
        html, body {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        overflow: hidden;
        }
        a-scene {
        width: 100%; height: 100%;
        position: fixed; top: 0; left: 0;
        }
        /* 隱藏所有 MindAR 預設 UI */
        .mindar-ui-loading,
        .mindar-ui-error,
        .mindar-ui-scanning {
        display: none;
        }
        
        /*UI Style*/

        #custom-btn {
        display: none;
        position: fixed;
        bottom: 10px; 
        left: 5%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 0.5em 1em;
        font-size: 1.5em;
        border-radius: 0.3em;
        z-index: 9999;
        pointer-events: auto;
        user-select: none;
        box-shadow: rgba(0, 0, 0, 0.4);
        transition: all 0.15s ease;
        }

        /*
        #custom-rightbtn {
        display: none; 
        position: fixed;
        bottom: 20px; 
        right: 25%;
        transform: translateX(50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 0.5em 1em;
        font-size: 1.5em;
        border-radius: 0.3em;
        z-index: 9999;
        pointer-events: auto;
        user-select: none;
        box-shadow: rgba(0, 0, 0, 0.4);
        transition: all 0.15s ease;
        }*/

        #custom-btn:active {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            transform: scale(0.95) translateX(-50%);
        }

        /*
        #custom-rightbtn:active {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.6);
            transform: scale(0.95) translateX(50%);
        }
        */

        img.Btn {
            pointer-events: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .slide-zone{
            position: fixed;
            bottom: 50px;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9998;
            pointer-events: auto;
        }

        </style>
    </head>
    <body>
        <!--25.5.6 0.2Ver Single Planets / Slide Rotation-->
        <!-- UI Scene -->
        <button type="button" id="custom-btn" disabled><img src="./UIPhoto/info.png" class="Btn"></button>
        <!--<button type="button" id="custom-leftbtn" disabled><img src="./UIPhoto/arrow_left.png" class="Btn"></button>
        <button type="button" id="custom-rightbtn" disabled><img src="./UIPhoto/arrow_right.png" class="Btn"></button>-->

        <!--Slide Zone-->
        <div class="slide-zone" id="slideZone"></div>
        <!--AR Scene -->

        <a-scene
        mindar-image="
        imageTargetSrc: targets.mind;
        autoStart: true;
        showStats: false;
        uiLoading: no;
        uiScanning: no;
        uiError: no;
        "
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        >
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!--Model Assets(PreLoad)-->
        <a-assets>
            <a-assets-item id="jupiterAssetsItem" src="./jupiter_model/scene.gltf"></a-assets-item>
            
        </a-assets>

        <!--AR Scan Entity-->

        <a-entity class="target" data-index="jupiter" mindar-image-target="targetIndex: 0"></a-entity>

        <!--AR Model (Showing in Scene)-->

        <a-entity gltf-model="#jupiterAssetsItem" id="jupiterModel" position="0 0 -30" scale="0.05 0.05 0.05" visible="false" slide-rotate="enabled = false;"></a-entity>

        </a-scene>
        
        <script>
        window.addEventListener("load", () => {
        /*function resizeSlideZone(){
            const slideZone = document.getElementById("slideZone");
            const screenHeight = window.innerHeight;

            slideZone.style.height = `${screenHeight * 0.2} px`;
        }
        //SlideZoneSet&Resize
        resizeSlideZone();*/
        
        //Model Const
        const jupiterModel = document.querySelector("#jupiterModel");

        // UI Const
        const TextBtn = document.getElementById('custom-btn');

        //AR Scanner & ModelSelector
        document.querySelectorAll('.target').forEach(target =>{
            target.addEventListener('targetFound', () =>{
                const dataName = target.dataset.index;

                if(dataName === "jupiter"){
                    jupiterModel.setAttribute("visible",true);
                    jupiterModel.setAttribute("slide-rotate", "enabled", true);
                }

                TextBtn.disabled = false;
                TextBtn.style.display = "block";
            });

            target.addEventListener('targetLost', () =>{
                //Model hide(*)
                jupiterModel.setAttribute("visible",false);
                jupiterModel.setAttribute("slide-rotate", "enabled", false);

                TextBtn.disabled = false;
                TextBtn.style.display = "block";
            });
        });

        //A-Frame Component 
        AFRAME.registerComponent('touch-rotation', {
            schema: {
                speedFactor: { default: 0.1 },    // 旋轉速度因子
                enableXRotation: { default: true }, // 是否啟用X軸旋轉（上下滑動）
                enableYRotation: { default: true }, // 是否啟用Y軸旋轉（左右滑動）
                minRotationX: { default: -90 },    // X軸最小旋轉角度（度）
                maxRotationX: { default: 90 }      // X軸最大旋轉角度（度）
            },
            
            init: function() {
                this.xRotation = 0;
                this.yRotation = 0;
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.isRotating = false;
                
                // 保存模型的初始旋轉
                const rotation = this.el.object3D.rotation;
                this.xRotation = THREE.MathUtils.radToDeg(rotation.x);
                this.yRotation = THREE.MathUtils.radToDeg(rotation.y);
                
                // 綁定事件處理函數的上下文
                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchMove = this.onTouchMove.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);
                
                // 為整個文檔添加觸摸事件監聽器
                document.addEventListener('touchstart', this.onTouchStart);
                document.addEventListener('touchmove', this.onTouchMove);
                document.addEventListener('touchend', this.onTouchEnd);
                
                console.log("Touch rotation component initialized");
            },
            
            onTouchStart: function(event) {
                if (event.touches.length === 1) {
                    this.isRotating = true;
                    this.touchStartX = event.touches[0].pageX;
                    this.touchStartY = event.touches[0].pageY;
                    event.preventDefault();
                }
            },
            
            onTouchMove: function(event) {
                if (!this.isRotating || event.touches.length !== 1) return;
                
                const touchX = event.touches[0].pageX;
                const touchY = event.touches[0].pageY;
                
                const deltaX = touchX - this.touchStartX;
                const deltaY = touchY - this.touchStartY;
                
                // Y 軸旋轉（左右滑動）
                if (this.data.enableYRotation) {
                    this.yRotation += deltaX * this.data.speedFactor;
                }
                
                // X 軸旋轉（上下滑動）
                if (this.data.enableXRotation) {
                    const newXRotation = this.xRotation - deltaY * this.data.speedFactor;
                    // 限制X軸旋轉範圍
                    this.xRotation = Math.max(this.data.minRotationX, Math.min(this.data.maxRotationX, newXRotation));
                }
                
                // 應用旋轉
                this.el.object3D.rotation.set(
                    THREE.MathUtils.degToRad(this.xRotation),
                    THREE.MathUtils.degToRad(this.yRotation),
                    0
                );
                
                // 更新觸摸起點
                this.touchStartX = touchX;
                this.touchStartY = touchY;
                
                event.preventDefault();
            },
            
            onTouchEnd: function() {
                this.isRotating = false;
            },
            
            remove: function() {
                // 移除事件監聽器
                document.removeEventListener('touchstart', this.onTouchStart);
                document.removeEventListener('touchmove', this.onTouchMove);
                document.removeEventListener('touchend', this.onTouchEnd);
            }
        });

        document.querySelectorAll('img.Btn').forEach(img =>{
            img.addEventListener('touchstart',e => e.preventDefault());
        });

        });

        </script>
    </body>
</html>

